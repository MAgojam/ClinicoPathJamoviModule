
# This file is automatically generated, you probably don't want to edit this

clinmonOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinmonOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time_var = NULL,
            abp = NULL,
            mcav = NULL,
            icp = NULL,
            cpp = NULL,
            hr = NULL,
            freq = 1000,
            blocksize = 3,
            epochsize = 20,
            output_level = "period",
            overlapping = FALSE,
            blockmin = 0.5,
            epochmin = 0.5,
            fast_processing = FALSE,
            show_summary = TRUE,
            show_detailed = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="clinmon",
                requiresData=TRUE,
                ...)

            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..abp <- jmvcore::OptionVariable$new(
                "abp",
                abp,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..mcav <- jmvcore::OptionVariable$new(
                "mcav",
                mcav,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..icp <- jmvcore::OptionVariable$new(
                "icp",
                icp,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..cpp <- jmvcore::OptionVariable$new(
                "cpp",
                cpp,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..hr <- jmvcore::OptionVariable$new(
                "hr",
                hr,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..freq <- jmvcore::OptionInteger$new(
                "freq",
                freq,
                min=1,
                max=10000,
                default=1000)
            private$..blocksize <- jmvcore::OptionInteger$new(
                "blocksize",
                blocksize,
                min=1,
                max=60,
                default=3)
            private$..epochsize <- jmvcore::OptionInteger$new(
                "epochsize",
                epochsize,
                min=1,
                max=100,
                default=20)
            private$..output_level <- jmvcore::OptionList$new(
                "output_level",
                output_level,
                options=list(
                    "period",
                    "epoch",
                    "block",
                    "cppopt"),
                default="period")
            private$..overlapping <- jmvcore::OptionBool$new(
                "overlapping",
                overlapping,
                default=FALSE)
            private$..blockmin <- jmvcore::OptionNumber$new(
                "blockmin",
                blockmin,
                min=0.1,
                max=1,
                default=0.5)
            private$..epochmin <- jmvcore::OptionNumber$new(
                "epochmin",
                epochmin,
                min=0.1,
                max=1,
                default=0.5)
            private$..fast_processing <- jmvcore::OptionBool$new(
                "fast_processing",
                fast_processing,
                default=FALSE)
            private$..show_summary <- jmvcore::OptionBool$new(
                "show_summary",
                show_summary,
                default=TRUE)
            private$..show_detailed <- jmvcore::OptionBool$new(
                "show_detailed",
                show_detailed,
                default=FALSE)

            self$.addOption(private$..time_var)
            self$.addOption(private$..abp)
            self$.addOption(private$..mcav)
            self$.addOption(private$..icp)
            self$.addOption(private$..cpp)
            self$.addOption(private$..hr)
            self$.addOption(private$..freq)
            self$.addOption(private$..blocksize)
            self$.addOption(private$..epochsize)
            self$.addOption(private$..output_level)
            self$.addOption(private$..overlapping)
            self$.addOption(private$..blockmin)
            self$.addOption(private$..epochmin)
            self$.addOption(private$..fast_processing)
            self$.addOption(private$..show_summary)
            self$.addOption(private$..show_detailed)
        }),
    active = list(
        time_var = function() private$..time_var$value,
        abp = function() private$..abp$value,
        mcav = function() private$..mcav$value,
        icp = function() private$..icp$value,
        cpp = function() private$..cpp$value,
        hr = function() private$..hr$value,
        freq = function() private$..freq$value,
        blocksize = function() private$..blocksize$value,
        epochsize = function() private$..epochsize$value,
        output_level = function() private$..output_level$value,
        overlapping = function() private$..overlapping$value,
        blockmin = function() private$..blockmin$value,
        epochmin = function() private$..epochmin$value,
        fast_processing = function() private$..fast_processing$value,
        show_summary = function() private$..show_summary$value,
        show_detailed = function() private$..show_detailed$value),
    private = list(
        ..time_var = NA,
        ..abp = NA,
        ..mcav = NA,
        ..icp = NA,
        ..cpp = NA,
        ..hr = NA,
        ..freq = NA,
        ..blocksize = NA,
        ..epochsize = NA,
        ..output_level = NA,
        ..overlapping = NA,
        ..blockmin = NA,
        ..epochmin = NA,
        ..fast_processing = NA,
        ..show_summary = NA,
        ..show_detailed = NA)
)

clinmonResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinmonResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        summary_stats = function() private$.items[["summary_stats"]],
        detailed_results = function() private$.items[["detailed_results"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Clinical Hemodynamic Monitoring",
                refs=list(
                    "clintools",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                clearWith=list(
                    "time_var",
                    "abp",
                    "mcav",
                    "icp",
                    "cpp",
                    "hr")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary_stats",
                title="Summary Statistics",
                visible="(show_summary)",
                clearWith=list(
                    "time_var",
                    "abp",
                    "mcav",
                    "icp",
                    "cpp",
                    "hr",
                    "freq",
                    "blocksize",
                    "epochsize",
                    "output_level",
                    "overlapping",
                    "blockmin",
                    "epochmin",
                    "fast_processing",
                    "show_summary")))
            self$add(jmvcore::Html$new(
                options=options,
                name="detailed_results",
                title="Detailed Results",
                visible="(show_detailed)",
                clearWith=list(
                    "time_var",
                    "abp",
                    "mcav",
                    "icp",
                    "cpp",
                    "hr",
                    "freq",
                    "blocksize",
                    "epochsize",
                    "output_level",
                    "overlapping",
                    "blockmin",
                    "epochmin",
                    "fast_processing",
                    "show_detailed")))}))

clinmonBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinmonBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "clinmon",
                version = c(0,0,3),
                options = options,
                results = clinmonResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Clinical Hemodynamic Monitoring
#'
#' Calculates hemodynamic indices from continuous clinical monitoring data. 
#' Uses the clintools package to compute COest, CPPopt, CVRi, Dx, Mx, PI, PRx, 
#' PWA, RI, and Sx from continuous recordings of arterial blood pressure, 
#' intracranial pressure,  middle cerebral artery blood velocity, and heart 
#' rate.
#'
#' @examples
#' \donttest{
#' # example will be added
#'}
#' @param data The data as a data frame with continuous monitoring data.
#'   First column must be time in seconds, followed by physiological variables.
#' @param time_var Time variable in seconds. This should be the first column
#'   and contain  continuous time measurements from the monitoring system.
#' @param abp Arterial blood pressure measurements in mmHg. Used for
#'   calculating  multiple hemodynamic indices including PRx, Mx, Sx, Dx, CVRi,
#'   and COest.
#' @param mcav Middle cerebral artery blood velocity measurements. Used for
#'   calculating Mx, Sx, Dx, CVRi, PI, and RI indices.
#' @param icp Intracranial pressure measurements in mmHg. Used for calculating
#'   PRx and CPPopt indices when combined with arterial blood pressure.
#' @param cpp Cerebral perfusion pressure measurements in mmHg. Alternative to
#'   ICP for calculating Mx, Sx, and Dx indices.
#' @param hr Heart rate measurements in beats per minute. Used for calculating
#'   estimated cardiac output (COest).
#' @param freq Frequency of recorded data in Hz. Default is 1000 Hz for
#'   high-resolution monitoring systems. Adjust based on your data collection
#'   frequency.
#' @param blocksize Length of a block in seconds. Blocks are the fundamental
#'   units for calculating indices. Default is 3 seconds.
#' @param epochsize Size of epochs in number of blocks. Epochs aggregate
#'   multiple blocks for correlation-based indices. Default is 20 blocks.
#' @param output_level Select what each output row should represent: - Period:
#'   Analysis periods (requires trigger data) - Epoch: Epoch-level results
#'   (correlation indices available) - Block: Block-level results (no
#'   correlation indices) - CPPopt: Optimal cerebral perfusion pressure analysis
#' @param overlapping Enable overlapping calculations for correlation-based
#'   indices. This can improve temporal resolution but increases computation
#'   time.
#' @param blockmin Minimum measurements required to create a block as a
#'   percentage. Blocks with less data will be omitted. Default is 50\%.
#' @param epochmin Minimum blocks required to create an epoch as a percentage.
#'   Epochs with fewer blocks will be omitted. Default is 50\%.
#' @param fast_processing Enable fast processing by aggregating data before
#'   analysis. This speeds up computation but may reduce precision.
#' @param show_summary Display summary statistics for calculated hemodynamic
#'   indices.
#' @param show_detailed Display detailed results table with all calculated
#'   indices for each time period/epoch/block.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary_stats} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$detailed_results} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
clinmon <- function(
    data,
    time_var,
    abp,
    mcav,
    icp,
    cpp,
    hr,
    freq = 1000,
    blocksize = 3,
    epochsize = 20,
    output_level = "period",
    overlapping = FALSE,
    blockmin = 0.5,
    epochmin = 0.5,
    fast_processing = FALSE,
    show_summary = TRUE,
    show_detailed = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("clinmon requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(abp)) abp <- jmvcore::resolveQuo(jmvcore::enquo(abp))
    if ( ! missing(mcav)) mcav <- jmvcore::resolveQuo(jmvcore::enquo(mcav))
    if ( ! missing(icp)) icp <- jmvcore::resolveQuo(jmvcore::enquo(icp))
    if ( ! missing(cpp)) cpp <- jmvcore::resolveQuo(jmvcore::enquo(cpp))
    if ( ! missing(hr)) hr <- jmvcore::resolveQuo(jmvcore::enquo(hr))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(abp), abp, NULL),
            `if`( ! missing(mcav), mcav, NULL),
            `if`( ! missing(icp), icp, NULL),
            `if`( ! missing(cpp), cpp, NULL),
            `if`( ! missing(hr), hr, NULL))


    options <- clinmonOptions$new(
        time_var = time_var,
        abp = abp,
        mcav = mcav,
        icp = icp,
        cpp = cpp,
        hr = hr,
        freq = freq,
        blocksize = blocksize,
        epochsize = epochsize,
        output_level = output_level,
        overlapping = overlapping,
        blockmin = blockmin,
        epochmin = epochmin,
        fast_processing = fast_processing,
        show_summary = show_summary,
        show_detailed = show_detailed)

    analysis <- clinmonClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

