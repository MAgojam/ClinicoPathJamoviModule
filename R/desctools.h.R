
# This file is automatically generated, you probably don't want to edit this

desctoolsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "desctoolsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            effect_size_analysis = FALSE,
            group_var = NULL,
            continuous_var = NULL,
            pooled_sd = TRUE,
            hedges_correction = FALSE,
            effect_ci_level = 0.95,
            goodness_of_fit = FALSE,
            fitted_probs = NULL,
            observed_outcomes = NULL,
            hl_groups = 10,
            normality_var = NULL,
            categorical_tests = FALSE,
            cat_var1 = NULL,
            cat_var2 = NULL,
            stratum_var = NULL,
            ordered_exposure = NULL,
            binary_outcome = NULL,
            multiple_testing = "none",
            show_effect_sizes = TRUE,
            show_goodness_tests = TRUE,
            show_categorical_tests = TRUE,
            show_interpretations = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="desctools",
                requiresData=TRUE,
                ...)

            private$..effect_size_analysis <- jmvcore::OptionBool$new(
                "effect_size_analysis",
                effect_size_analysis,
                default=FALSE)
            private$..group_var <- jmvcore::OptionVariable$new(
                "group_var",
                group_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..continuous_var <- jmvcore::OptionVariable$new(
                "continuous_var",
                continuous_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..pooled_sd <- jmvcore::OptionBool$new(
                "pooled_sd",
                pooled_sd,
                default=TRUE)
            private$..hedges_correction <- jmvcore::OptionBool$new(
                "hedges_correction",
                hedges_correction,
                default=FALSE)
            private$..effect_ci_level <- jmvcore::OptionNumber$new(
                "effect_ci_level",
                effect_ci_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..goodness_of_fit <- jmvcore::OptionBool$new(
                "goodness_of_fit",
                goodness_of_fit,
                default=FALSE)
            private$..fitted_probs <- jmvcore::OptionVariable$new(
                "fitted_probs",
                fitted_probs,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..observed_outcomes <- jmvcore::OptionVariable$new(
                "observed_outcomes",
                observed_outcomes,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..hl_groups <- jmvcore::OptionInteger$new(
                "hl_groups",
                hl_groups,
                min=5,
                max=20,
                default=10)
            private$..normality_var <- jmvcore::OptionVariable$new(
                "normality_var",
                normality_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..categorical_tests <- jmvcore::OptionBool$new(
                "categorical_tests",
                categorical_tests,
                default=FALSE)
            private$..cat_var1 <- jmvcore::OptionVariable$new(
                "cat_var1",
                cat_var1,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..cat_var2 <- jmvcore::OptionVariable$new(
                "cat_var2",
                cat_var2,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..stratum_var <- jmvcore::OptionVariable$new(
                "stratum_var",
                stratum_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..ordered_exposure <- jmvcore::OptionVariable$new(
                "ordered_exposure",
                ordered_exposure,
                suggested=list(
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..binary_outcome <- jmvcore::OptionVariable$new(
                "binary_outcome",
                binary_outcome,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..multiple_testing <- jmvcore::OptionList$new(
                "multiple_testing",
                multiple_testing,
                options=list(
                    "none",
                    "bonferroni",
                    "holm",
                    "BH",
                    "BY"),
                default="none")
            private$..show_effect_sizes <- jmvcore::OptionBool$new(
                "show_effect_sizes",
                show_effect_sizes,
                default=TRUE)
            private$..show_goodness_tests <- jmvcore::OptionBool$new(
                "show_goodness_tests",
                show_goodness_tests,
                default=TRUE)
            private$..show_categorical_tests <- jmvcore::OptionBool$new(
                "show_categorical_tests",
                show_categorical_tests,
                default=TRUE)
            private$..show_interpretations <- jmvcore::OptionBool$new(
                "show_interpretations",
                show_interpretations,
                default=TRUE)

            self$.addOption(private$..effect_size_analysis)
            self$.addOption(private$..group_var)
            self$.addOption(private$..continuous_var)
            self$.addOption(private$..pooled_sd)
            self$.addOption(private$..hedges_correction)
            self$.addOption(private$..effect_ci_level)
            self$.addOption(private$..goodness_of_fit)
            self$.addOption(private$..fitted_probs)
            self$.addOption(private$..observed_outcomes)
            self$.addOption(private$..hl_groups)
            self$.addOption(private$..normality_var)
            self$.addOption(private$..categorical_tests)
            self$.addOption(private$..cat_var1)
            self$.addOption(private$..cat_var2)
            self$.addOption(private$..stratum_var)
            self$.addOption(private$..ordered_exposure)
            self$.addOption(private$..binary_outcome)
            self$.addOption(private$..multiple_testing)
            self$.addOption(private$..show_effect_sizes)
            self$.addOption(private$..show_goodness_tests)
            self$.addOption(private$..show_categorical_tests)
            self$.addOption(private$..show_interpretations)
        }),
    active = list(
        effect_size_analysis = function() private$..effect_size_analysis$value,
        group_var = function() private$..group_var$value,
        continuous_var = function() private$..continuous_var$value,
        pooled_sd = function() private$..pooled_sd$value,
        hedges_correction = function() private$..hedges_correction$value,
        effect_ci_level = function() private$..effect_ci_level$value,
        goodness_of_fit = function() private$..goodness_of_fit$value,
        fitted_probs = function() private$..fitted_probs$value,
        observed_outcomes = function() private$..observed_outcomes$value,
        hl_groups = function() private$..hl_groups$value,
        normality_var = function() private$..normality_var$value,
        categorical_tests = function() private$..categorical_tests$value,
        cat_var1 = function() private$..cat_var1$value,
        cat_var2 = function() private$..cat_var2$value,
        stratum_var = function() private$..stratum_var$value,
        ordered_exposure = function() private$..ordered_exposure$value,
        binary_outcome = function() private$..binary_outcome$value,
        multiple_testing = function() private$..multiple_testing$value,
        show_effect_sizes = function() private$..show_effect_sizes$value,
        show_goodness_tests = function() private$..show_goodness_tests$value,
        show_categorical_tests = function() private$..show_categorical_tests$value,
        show_interpretations = function() private$..show_interpretations$value),
    private = list(
        ..effect_size_analysis = NA,
        ..group_var = NA,
        ..continuous_var = NA,
        ..pooled_sd = NA,
        ..hedges_correction = NA,
        ..effect_ci_level = NA,
        ..goodness_of_fit = NA,
        ..fitted_probs = NA,
        ..observed_outcomes = NA,
        ..hl_groups = NA,
        ..normality_var = NA,
        ..categorical_tests = NA,
        ..cat_var1 = NA,
        ..cat_var2 = NA,
        ..stratum_var = NA,
        ..ordered_exposure = NA,
        ..binary_outcome = NA,
        ..multiple_testing = NA,
        ..show_effect_sizes = NA,
        ..show_goodness_tests = NA,
        ..show_categorical_tests = NA,
        ..show_interpretations = NA)
)

desctoolsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "desctoolsResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        effect_size_results = function() private$.items[["effect_size_results"]],
        goodness_fit_results = function() private$.items[["goodness_fit_results"]],
        categorical_results = function() private$.items[["categorical_results"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Advanced Statistical Tests",
                refs=list(
                    "DescTools",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                clearWith=list(
                    "effect_size_analysis",
                    "goodness_of_fit",
                    "categorical_tests")))
            self$add(jmvcore::Html$new(
                options=options,
                name="effect_size_results",
                title="Effect Size Analysis",
                visible="(effect_size_analysis && show_effect_sizes)",
                clearWith=list(
                    "group_var",
                    "continuous_var",
                    "pooled_sd",
                    "hedges_correction",
                    "effect_ci_level",
                    "multiple_testing")))
            self$add(jmvcore::Html$new(
                options=options,
                name="goodness_fit_results",
                title="Goodness of Fit Tests",
                visible="(goodness_of_fit && show_goodness_tests)",
                clearWith=list(
                    "fitted_probs",
                    "observed_outcomes",
                    "hl_groups",
                    "normality_var",
                    "multiple_testing")))
            self$add(jmvcore::Html$new(
                options=options,
                name="categorical_results",
                title="Categorical Data Tests",
                visible="(categorical_tests && show_categorical_tests)",
                clearWith=list(
                    "cat_var1",
                    "cat_var2",
                    "stratum_var",
                    "ordered_exposure",
                    "binary_outcome",
                    "multiple_testing")))}))

desctoolsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "desctoolsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "desctools",
                version = c(0,0,3),
                options = options,
                results = desctoolsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Advanced Statistical Tests
#'
#' Advanced statistical tests using functions from the DescTools package. 
#' Includes effect size calculations (Cohen's D), goodness-of-fit tests  
#' (Hosmer-Lemeshow, Anderson-Darling), agreement tests (Barnard, 
#' Breslow-Day), and trend tests (Cochran-Armitage). Essential for clinical 
#' research, epidemiological studies, and advanced statistical analysis.
#'
#' @examples
#' # Load example data
#' data("histopathology")
#' data("dca_test_data")
#' data("BreastCancer")
#'
#' # Example 1: Effect Size Analysis - Compare age between treatment groups
#' desctools(
#'     data = histopathology,
#'     effect_size_analysis = TRUE,
#'     group_var = "Group",
#'     continuous_var = "Age",
#'     pooled_sd = TRUE,
#'     hedges_correction = FALSE,
#'     effect_ci_level = 0.95
#' )
#'
#' # Example 2: Goodness of Fit - Hosmer-Lemeshow test for model validation
#' desctools(
#'     data = dca_test_data,
#'     goodness_of_fit = TRUE,
#'     fitted_probs = "basic_model",
#'     observed_outcomes = "cardiac_event_numeric",
#'     hl_groups = 10
#' )
#'
#' # Example 3: Categorical Analysis - Test for trend across tumor grades
#' desctools(
#'     data = histopathology,
#'     categorical_tests = TRUE,
#'     ordered_exposure = "Grade",
#'     binary_outcome = "Death"
#' )
#'
#' # Example 4: Comprehensive Analysis - All three analysis types
#' desctools(
#'     data = histopathology,
#'     effect_size_analysis = TRUE,
#'     group_var = "Group",
#'     continuous_var = "Age",
#'     goodness_of_fit = TRUE,
#'     normality_var = "MeasurementA",
#'     categorical_tests = TRUE,
#'     ordered_exposure = "Grade",
#'     binary_outcome = "Death",
#'     multiple_testing = "BH",
#'     show_interpretations = TRUE
#' )
#'
#' # Example 5: Clinical Application - Biomarker validation
#' desctools(
#'     data = BreastCancer,
#'     effect_size_analysis = TRUE,
#'     group_var = "Class",
#'     continuous_var = "Cl.thickness",
#'     hedges_correction = TRUE,
#'     goodness_of_fit = TRUE,
#'     normality_var = "Cell.size",
#'     multiple_testing = "BH"
#' )
#'
#' @param data The data as a data frame for statistical analysis.
#' @param effect_size_analysis Calculate effect sizes including Cohen's D for
#'   comparing group means. Essential for determining practical significance in
#'   clinical studies.
#' @param group_var Categorical variable defining groups for effect size
#'   comparison. Should have exactly 2 levels for Cohen's D calculation.
#' @param continuous_var Continuous variable for effect size calculation
#'   (outcome measure).
#' @param pooled_sd Use pooled standard deviation for Cohen's D calculation.
#'   Recommended when group variances are similar.
#' @param hedges_correction Apply Hedges correction for small sample bias in
#'   effect size calculation.
#' @param effect_ci_level Confidence level for effect size confidence
#'   intervals.
#' @param goodness_of_fit Perform goodness of fit tests including
#'   Hosmer-Lemeshow test for logistic regression models and normality tests.
#' @param fitted_probs Fitted probabilities from a logistic regression model
#'   for Hosmer-Lemeshow goodness of fit test.
#' @param observed_outcomes Observed binary outcomes (0/1) for Hosmer-Lemeshow
#'   test.
#' @param hl_groups Number of groups for Hosmer-Lemeshow test. Usually 10
#'   groups provide good balance between power and stability.
#' @param normality_var Continuous variable for normality testing using
#'   Anderson-Darling and other goodness of fit tests.
#' @param categorical_tests Perform advanced tests for categorical data
#'   including Barnard's test, Breslow-Day test, and Cochran-Armitage trend
#'   test.
#' @param cat_var1 First categorical variable for contingency table analysis.
#' @param cat_var2 Second categorical variable for contingency table analysis.
#' @param stratum_var Stratification variable for Breslow-Day test of
#'   homogeneity of odds ratios across strata.
#' @param ordered_exposure Ordered exposure variable for Cochran-Armitage
#'   trend test. Should represent ordered dose or exposure levels.
#' @param binary_outcome Binary outcome variable for Cochran-Armitage trend
#'   test.
#' @param multiple_testing Method for correcting p-values when multiple tests
#'   are performed. FDR (Benjamini-Hochberg) is recommended for most clinical
#'   studies.
#' @param show_effect_sizes Display effect size calculations including Cohen's
#'   D with confidence intervals and interpretation.
#' @param show_goodness_tests Display goodness of fit test results including
#'   Hosmer-Lemeshow and normality tests.
#' @param show_categorical_tests Display results of advanced categorical data
#'   tests.
#' @param show_interpretations Provide clinical interpretations and guidelines
#'   for statistical results to aid in medical decision making.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$effect_size_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$goodness_fit_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$categorical_results} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
desctools <- function(
    data,
    effect_size_analysis = FALSE,
    group_var,
    continuous_var,
    pooled_sd = TRUE,
    hedges_correction = FALSE,
    effect_ci_level = 0.95,
    goodness_of_fit = FALSE,
    fitted_probs,
    observed_outcomes,
    hl_groups = 10,
    normality_var,
    categorical_tests = FALSE,
    cat_var1,
    cat_var2,
    stratum_var,
    ordered_exposure,
    binary_outcome,
    multiple_testing = "none",
    show_effect_sizes = TRUE,
    show_goodness_tests = TRUE,
    show_categorical_tests = TRUE,
    show_interpretations = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("desctools requires jmvcore to be installed (restart may be required)")

    if ( ! missing(group_var)) group_var <- jmvcore::resolveQuo(jmvcore::enquo(group_var))
    if ( ! missing(continuous_var)) continuous_var <- jmvcore::resolveQuo(jmvcore::enquo(continuous_var))
    if ( ! missing(fitted_probs)) fitted_probs <- jmvcore::resolveQuo(jmvcore::enquo(fitted_probs))
    if ( ! missing(observed_outcomes)) observed_outcomes <- jmvcore::resolveQuo(jmvcore::enquo(observed_outcomes))
    if ( ! missing(normality_var)) normality_var <- jmvcore::resolveQuo(jmvcore::enquo(normality_var))
    if ( ! missing(cat_var1)) cat_var1 <- jmvcore::resolveQuo(jmvcore::enquo(cat_var1))
    if ( ! missing(cat_var2)) cat_var2 <- jmvcore::resolveQuo(jmvcore::enquo(cat_var2))
    if ( ! missing(stratum_var)) stratum_var <- jmvcore::resolveQuo(jmvcore::enquo(stratum_var))
    if ( ! missing(ordered_exposure)) ordered_exposure <- jmvcore::resolveQuo(jmvcore::enquo(ordered_exposure))
    if ( ! missing(binary_outcome)) binary_outcome <- jmvcore::resolveQuo(jmvcore::enquo(binary_outcome))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(group_var), group_var, NULL),
            `if`( ! missing(continuous_var), continuous_var, NULL),
            `if`( ! missing(fitted_probs), fitted_probs, NULL),
            `if`( ! missing(observed_outcomes), observed_outcomes, NULL),
            `if`( ! missing(normality_var), normality_var, NULL),
            `if`( ! missing(cat_var1), cat_var1, NULL),
            `if`( ! missing(cat_var2), cat_var2, NULL),
            `if`( ! missing(stratum_var), stratum_var, NULL),
            `if`( ! missing(ordered_exposure), ordered_exposure, NULL),
            `if`( ! missing(binary_outcome), binary_outcome, NULL))

    for (v in group_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in cat_var1) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in cat_var2) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in stratum_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- desctoolsOptions$new(
        effect_size_analysis = effect_size_analysis,
        group_var = group_var,
        continuous_var = continuous_var,
        pooled_sd = pooled_sd,
        hedges_correction = hedges_correction,
        effect_ci_level = effect_ci_level,
        goodness_of_fit = goodness_of_fit,
        fitted_probs = fitted_probs,
        observed_outcomes = observed_outcomes,
        hl_groups = hl_groups,
        normality_var = normality_var,
        categorical_tests = categorical_tests,
        cat_var1 = cat_var1,
        cat_var2 = cat_var2,
        stratum_var = stratum_var,
        ordered_exposure = ordered_exposure,
        binary_outcome = binary_outcome,
        multiple_testing = multiple_testing,
        show_effect_sizes = show_effect_sizes,
        show_goodness_tests = show_goodness_tests,
        show_categorical_tests = show_categorical_tests,
        show_interpretations = show_interpretations)

    analysis <- desctoolsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

