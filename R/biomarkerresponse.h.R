
# This file is automatically generated, you probably don't want to edit this

biomarkerresponseOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "biomarkerresponseOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            biomarker = NULL,
            response = NULL,
            responseType = "categorical",
            plotType = "boxplot",
            showThreshold = TRUE,
            thresholdValue = NULL,
            thresholdMethod = "median",
            addTrendLine = TRUE,
            trendMethod = "loess",
            performTests = TRUE,
            groupVariable = NULL,
            showCorrelation = TRUE,
            logTransform = FALSE,
            outlierHandling = "highlight",
            confidenceLevel = "0.95", ...) {

            super$initialize(
                package="ClinicoPath",
                name="biomarkerresponse",
                requiresData=TRUE,
                ...)

            private$..biomarker <- jmvcore::OptionVariable$new(
                "biomarker",
                biomarker,
                suggested=list(
                    "continuous"))
            private$..response <- jmvcore::OptionVariable$new(
                "response",
                response,
                suggested=list(
                    "nominal",
                    "continuous"))
            private$..responseType <- jmvcore::OptionList$new(
                "responseType",
                responseType,
                options=list(
                    "binary",
                    "categorical",
                    "continuous"),
                default="categorical")
            private$..plotType <- jmvcore::OptionList$new(
                "plotType",
                plotType,
                options=list(
                    "boxplot",
                    "scatter",
                    "violin",
                    "combined"),
                default="boxplot")
            private$..showThreshold <- jmvcore::OptionBool$new(
                "showThreshold",
                showThreshold,
                default=TRUE)
            private$..thresholdValue <- jmvcore::OptionNumber$new(
                "thresholdValue",
                thresholdValue)
            private$..thresholdMethod <- jmvcore::OptionList$new(
                "thresholdMethod",
                thresholdMethod,
                options=list(
                    "manual",
                    "median",
                    "q75",
                    "optimal"),
                default="median")
            private$..addTrendLine <- jmvcore::OptionBool$new(
                "addTrendLine",
                addTrendLine,
                default=TRUE)
            private$..trendMethod <- jmvcore::OptionList$new(
                "trendMethod",
                trendMethod,
                options=list(
                    "lm",
                    "loess",
                    "gam"),
                default="loess")
            private$..performTests <- jmvcore::OptionBool$new(
                "performTests",
                performTests,
                default=TRUE)
            private$..groupVariable <- jmvcore::OptionVariable$new(
                "groupVariable",
                groupVariable,
                suggested=list(
                    "nominal"))
            private$..showCorrelation <- jmvcore::OptionBool$new(
                "showCorrelation",
                showCorrelation,
                default=TRUE)
            private$..logTransform <- jmvcore::OptionBool$new(
                "logTransform",
                logTransform,
                default=FALSE)
            private$..outlierHandling <- jmvcore::OptionList$new(
                "outlierHandling",
                outlierHandling,
                options=list(
                    "none",
                    "highlight",
                    "remove"),
                default="highlight")
            private$..confidenceLevel <- jmvcore::OptionList$new(
                "confidenceLevel",
                confidenceLevel,
                options=list(
                    "0.95",
                    "0.90",
                    "0.99"),
                default="0.95")

            self$.addOption(private$..biomarker)
            self$.addOption(private$..response)
            self$.addOption(private$..responseType)
            self$.addOption(private$..plotType)
            self$.addOption(private$..showThreshold)
            self$.addOption(private$..thresholdValue)
            self$.addOption(private$..thresholdMethod)
            self$.addOption(private$..addTrendLine)
            self$.addOption(private$..trendMethod)
            self$.addOption(private$..performTests)
            self$.addOption(private$..groupVariable)
            self$.addOption(private$..showCorrelation)
            self$.addOption(private$..logTransform)
            self$.addOption(private$..outlierHandling)
            self$.addOption(private$..confidenceLevel)
        }),
    active = list(
        biomarker = function() private$..biomarker$value,
        response = function() private$..response$value,
        responseType = function() private$..responseType$value,
        plotType = function() private$..plotType$value,
        showThreshold = function() private$..showThreshold$value,
        thresholdValue = function() private$..thresholdValue$value,
        thresholdMethod = function() private$..thresholdMethod$value,
        addTrendLine = function() private$..addTrendLine$value,
        trendMethod = function() private$..trendMethod$value,
        performTests = function() private$..performTests$value,
        groupVariable = function() private$..groupVariable$value,
        showCorrelation = function() private$..showCorrelation$value,
        logTransform = function() private$..logTransform$value,
        outlierHandling = function() private$..outlierHandling$value,
        confidenceLevel = function() private$..confidenceLevel$value),
    private = list(
        ..biomarker = NA,
        ..response = NA,
        ..responseType = NA,
        ..plotType = NA,
        ..showThreshold = NA,
        ..thresholdValue = NA,
        ..thresholdMethod = NA,
        ..addTrendLine = NA,
        ..trendMethod = NA,
        ..performTests = NA,
        ..groupVariable = NA,
        ..showCorrelation = NA,
        ..logTransform = NA,
        ..outlierHandling = NA,
        ..confidenceLevel = NA)
)

biomarkerresponseResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "biomarkerresponseResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        plot = function() private$.items[["plot"]],
        correlation = function() private$.items[["correlation"]],
        threshold = function() private$.items[["threshold"]],
        groupComparison = function() private$.items[["groupComparison"]],
        statisticalTests = function() private$.items[["statisticalTests"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Biomarker Response Association",
                refs=list(
                    "pROC",
                    "ggplot2",
                    "dplyr",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Biomarker-Response Plot",
                width=600,
                height=400,
                requiresData=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="correlation",
                title="Correlation Analysis",
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="correlation", 
                        `title`="Correlation", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pvalue", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="threshold",
                title="Threshold Analysis",
                columns=list(
                    list(
                        `name`="threshold", 
                        `title`="Threshold", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="npv", 
                        `title`="NPV", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="groupComparison",
                title="Response Group Comparison",
                columns=list(
                    list(
                        `name`="response_group", 
                        `title`="Response Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean", 
                        `title`="Mean", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="sd", 
                        `title`="SD", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="median", 
                        `title`="Median", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="iqr", 
                        `title`="IQR", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="statisticalTests",
                title="Statistical Tests",
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pvalue", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))}))

biomarkerresponseBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "biomarkerresponseBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "biomarkerresponse",
                version = c(0,0,3),
                options = options,
                results = biomarkerresponseResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Biomarker Response Association
#'
#' 
#' @param data The data as a data frame.
#' @param biomarker Continuous biomarker measurement (e.g., expression level,
#'   concentration).
#' @param response Treatment response variable (binary, categorical, or
#'   continuous).
#' @param responseType Type of response variable for appropriate analysis and
#'   visualization.
#' @param plotType Primary visualization method for biomarker-response
#'   relationship.
#' @param showThreshold Display threshold lines for biomarker
#'   positivity/negativity.
#' @param thresholdValue Threshold value for biomarker positivity (if known).
#' @param thresholdMethod Method for determining biomarker threshold.
#' @param addTrendLine Add fitted trend line for continuous responses.
#' @param trendMethod Method for fitting trend line.
#' @param performTests Perform appropriate statistical tests for
#'   biomarker-response association.
#' @param groupVariable Optional grouping variable (e.g., treatment arm,
#'   disease stage).
#' @param showCorrelation Display correlation coefficients and tests.
#' @param logTransform Apply log transformation to biomarker values.
#' @param outlierHandling Method for handling outlier values.
#' @param confidenceLevel Confidence level for intervals and tests.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$correlation} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$threshold} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$groupComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$statisticalTests} \tab \tab \tab \tab \tab a table \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$correlation$asDF}
#'
#' \code{as.data.frame(results$correlation)}
#'
#' @export
biomarkerresponse <- function(
    data,
    biomarker,
    response,
    responseType = "categorical",
    plotType = "boxplot",
    showThreshold = TRUE,
    thresholdValue,
    thresholdMethod = "median",
    addTrendLine = TRUE,
    trendMethod = "loess",
    performTests = TRUE,
    groupVariable,
    showCorrelation = TRUE,
    logTransform = FALSE,
    outlierHandling = "highlight",
    confidenceLevel = "0.95") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("biomarkerresponse requires jmvcore to be installed (restart may be required)")

    if ( ! missing(biomarker)) biomarker <- jmvcore::resolveQuo(jmvcore::enquo(biomarker))
    if ( ! missing(response)) response <- jmvcore::resolveQuo(jmvcore::enquo(response))
    if ( ! missing(groupVariable)) groupVariable <- jmvcore::resolveQuo(jmvcore::enquo(groupVariable))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(biomarker), biomarker, NULL),
            `if`( ! missing(response), response, NULL),
            `if`( ! missing(groupVariable), groupVariable, NULL))


    options <- biomarkerresponseOptions$new(
        biomarker = biomarker,
        response = response,
        responseType = responseType,
        plotType = plotType,
        showThreshold = showThreshold,
        thresholdValue = thresholdValue,
        thresholdMethod = thresholdMethod,
        addTrendLine = addTrendLine,
        trendMethod = trendMethod,
        performTests = performTests,
        groupVariable = groupVariable,
        showCorrelation = showCorrelation,
        logTransform = logTransform,
        outlierHandling = outlierHandling,
        confidenceLevel = confidenceLevel)

    analysis <- biomarkerresponseClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

